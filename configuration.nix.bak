{
  inputs,
  config,
  pkgs,
  lib,
  ...
}:

{
  imports = [
    ./hardware-configuration.nix
    ./customConfig
    # inputs.lanzaboote.nixosModules.lanzaboote # Ensure this is active in your flake.nix
  ];

  # Nix Package Manager Optimization
  nix = {
    settings = {
      experimental-features = [
        "nix-command"
        "flakes"
      ];
      auto-optimise-store = true;
      substituters = [ "https://nix-community.cachix.org" ];
      trusted-public-keys = [ "nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=" ];
    };
    gc = {
      automatic = true;
      dates = "weekly";
      options = "--delete-older-than 7d";
    };
  };

  # Graphics & Hardware
  hardware.graphics = {
    enable = true;
    enable32Bit = true; # Critical for Steam/Wine
  };

  glf.nvidia_config = {
    enable = true;
    laptop = false;
    nvidiaBusId = "PCI:1:0:0"; # RTX 5090
  };

  # Services & Performance
  services.lact.enable = true; # GPU Power/Clock control
  services.flatpak.enable = true;

  # Kernel & Boot
  boot = {
    kernelParams = [
      "amdgpu.ppfeaturemask=0xffffffff"
      "nosplit_lock_mitigate" # CPU optimization for gaming
      "nvidia-drm.modeset=1" # Stability for Plasma 6 / Wayland
      "nvidia.NVreg_PreserveVideoMemoryAllocations=1" # Fixes VRAM corruption on sleep
      "nvidia-drm.fbdev=1" # Recommended for better Wayland/Plasma 6 integration
    ];

    # Lanzaboote Secure Boot Configuration
    loader = {
      systemd-boot = {
        enable = lib.mkForce false;
        configurationLimit = 3;
      };
      efi.canTouchEfiVariables = true;
    };

    lanzaboote = {
      enable = true;
      pkiBundle = "/var/lib/sbctl";
    };
  };

  # Gaming & Steam Configuration
  programs.steam = {
    enable = true;
    gamescopeSession.enable = true;
    
    package = lib.mkForce (pkgs.steam.override {
    extraPkgs = pkgs: with pkgs; [ 
    gamemode
    pkgsi686Linux.gamemode  ];
    });
 
    protontricks.enable = true;
    remotePlay.openFirewall = true;
    dedicatedServer.openFirewall = true;
   
    extraPackages = with pkgs; [
    gamescope # HDR support and upscaling
    mangohud # Overlay for monitoring
    ];
  };

    programs.gamemode = {
    enable = true;
    settings = {
      cpu = {
        governor = "ignore";
      };
    };
  };

  # System Environment
  environment.systemPackages = with pkgs; [
    sbctl # Secure Boot keys management
    steam-run # Running random binaries in a Steam-like FHS
    nvtopPackages.nvidia
    vulkan-tools
    # Wine/Proton Font Support
    pkgsi686Linux.freetype
    pkgsi686Linux.libthai
  ];

  # Moza Racing Hardware Support
  services.udev.extraRules = ''
    # Moza Racing USB and HIDRAW Access
    SUBSYSTEMS=="usb", ATTRS{idVendor}=="1eaf", MODE="0666", TAG+="uaccess"
    SUBSYSTEMS=="usb", ATTRS{idVendor}=="346e", MODE="0666", TAG+="uaccess"
    KERNEL=="hidraw*", ATTRS{idVendor}=="1eaf", MODE="0666", TAG+="uaccess"
    KERNEL=="hidraw*", ATTRS{idVendor}=="346e", MODE="0666", TAG+="uaccess"
  '';

  # Desktop Environment
  glf.environment = {
    type = "plasma";
    edition = "standard";
  };

  # User & Localization
  users.users.radean = {
    isNormalUser = true;
    description = "Radean";
    extraGroups = [
      "networkmanager"
      "wheel"
      "dialout"
      "video"
      "gamemode"
    ];
  };

  networking = {
    hostName = "GLF-OS";
    networkmanager.enable = true;
  };

  time.timeZone = "America/New_York";
  i18n.defaultLocale = "en_US.UTF-8";

  fonts.packages = with pkgs; [
    corefonts
    vista-fonts
    noto-fonts-color-emoji
  ];

  # System State (Keep consistent for your 2026 deployment)
  system.stateVersion = "26.05";
  glf.mangohud.configuration = "disabled"; # Controlled via steam.extraPackages/MangoHud config files
}
