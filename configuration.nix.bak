{ inputs, config, pkgs, lib, ... }: {
  imports = [
    ./hardware-configuration.nix
  ];

  # --- Boot & Kernel (Performance Optimized) ---
  boot = {
    kernelPackages = lib.mkForce pkgs.linuxPackages_latest;

    # Performance-focused kernel parameters
    kernelParams = [
      # CPU Performance
      "intel_pstate=active"
      "intel_pstate=no_hwp"  # Disable HWP for more aggressive performance
      "processor.max_cstate=1"
      "idle=poll"  # Aggressive - prevents deep CPU sleep states

      # USB & Latency
      "usbcore.autosuspend=-1"

      # Security mitigations (disabled for max performance)
      "nosplit_lock_mitigate"
      "split_lock_detect=off"
      "mitigations=off"
      "nospectre_v1"
      "nospectre_v2"
      "spec_store_bypass_disable=off"
      "tsx=on"
      "tsx_async_abort=off"
      "mds=off"

      # NVIDIA
      "nvidia-drm.modeset=1"
      "nvidia-drm.fbdev=1"
      "nvidia.NVreg_PreserveVideoMemoryAllocations=1"
      "nvidia.NVreg_OpenRmEnableUnsupportedGpus=1"

      # System
      "nowatchdog"
      "nmi_watchdog=0"
      "quiet"
      "splash"
      "loglevel=3"
      "threadirqs"  # Threaded IRQs for better latency
    ];

    # Kernel modules for performance
    kernelModules = [ "tcp_bbr" ];

    # Sysctl tuning
    kernel.sysctl = {
      # Network performance
      "net.core.netdev_max_backlog" = 16384;
      "net.core.somaxconn" = 8192;
      "net.core.rmem_max" = 134217728;
      "net.core.wmem_max" = 134217728;
      "net.ipv4.tcp_rmem" = "4096 87380 134217728";
      "net.ipv4.tcp_wmem" = "4096 65536 134217728";
      "net.ipv4.tcp_congestion_control" = "bbr";
      "net.ipv4.tcp_fastopen" = 3;

      # VM/Memory performance
      "vm.swappiness" = 10;
      "vm.vfs_cache_pressure" = 50;
      "vm.dirty_ratio" = 10;
      "vm.dirty_background_ratio" = 5;
      "vm.dirty_writeback_centisecs" = 1500;

      # File system performance
      "fs.file-max" = 2097152;
      "fs.inotify.max_user_watches" = 524288;

      # Scheduler performance
      "kernel.sched_migration_cost_ns" = 5000000;
      "kernel.sched_autogroup_enabled" = 0;
    };

    loader = {
      efi.canTouchEfiVariables = true;
      systemd-boot.enable = lib.mkForce false;
      timeout = 1;  # Faster boot
    };

    lanzaboote = {
      enable = true;
      pkiBundle = "/var/lib/sbctl";
      configurationLimit = 3;
    };

    # Faster initrd
    initrd.systemd.enable = true;
    plymouth.enable = false;  # Disable for slightly faster boot
  };

  nix.settings = {
    experimental-features = [ "nix-command" "flakes" ];
    # Nix performance optimizations
    auto-optimise-store = true;
    max-jobs = "auto";
    cores = 0;  # Use all available cores
    sandbox = true;
  };

  # --- NVIDIA Graphics (Optimized) ---
  services.xserver.videoDrivers = [ "nvidia" ];

  hardware.graphics = {
    enable = true;
    enable32Bit = true;
    extraPackages = with pkgs; [
      libvdpau-va-gl
      nvidia-vaapi-driver
      libva-vdpau-driver  # Renamed from vaapiVdpau in NixOS 26.05
    ];
  };

  hardware.nvidia = {
    modesetting.enable = true;
    powerManagement.enable = false;  # Disable for max performance
    powerManagement.finegrained = false;
    open = true;
    nvidiaSettings = true;
    package = config.boot.kernelPackages.nvidiaPackages.stable;

    # Force maximum performance
    forceFullCompositionPipeline = false;  # Can cause input lag
  };

  # NVIDIA performance tweaks via environment
  environment.variables = {
    # Force maximum GPU clocks
    __GL_YIELD = "NOTHING";
    __GL_THREADED_OPTIMIZATION = "1";
    __GL_SYNC_TO_VBLANK = "0";
    KWIN_TRIPLE_BUFFER = "1";
  };

  # --- Bluetooth & Hardware Support ---
  hardware.bluetooth = {
    enable = true;
    powerOnBoot = true;
    settings = {
      General = {
        Enable = "Source,Sink,Media,Socket";
        Experimental = true;
      };
    };
  };

  services.udev.packages = [ pkgs.game-devices-udev-rules ];
  hardware.uinput.enable = true;

  # --- Performance & Core Services ---
  powerManagement = {
    enable = false;  # Disable power management for max performance
    cpuFreqGovernor = "performance";
  };

  services.thermald.enable = false;  # Not needed with performance governor
  services.lact.enable = true;

  # Disable zram for gaming/performance systems with adequate RAM
  zramSwap.enable = lib.mkForce false;

  # Systemd optimizations
  systemd = {
    services = {
      # Faster systemd timeouts
      systemd-udev-settle.enable = false;
      NetworkManager-wait-online.enable = false;
    };
    # New NixOS 26.05 syntax for systemd configuration
    settings.Manager = {
      DefaultTimeoutStopSec = "10s";
      DefaultTimeoutStartSec = "10s";
    };
  };

  services.displayManager.sddm = {
    enable = true;
    wayland.enable = true;  # Better performance than X11
  };

  services.desktopManager.plasma6 = {
    enable = true;
    enableQt5Integration = true;
  };

  # KDE performance settings
  environment.plasma6.excludePackages = with pkgs.kdePackages; [
    elisa  # Remove unused apps
    khelpcenter
  ];

  services.flatpak.enable = true;
  services.printing.enable = true;

  # --- Audio (Optimized Pipewire) ---
  security.rtkit.enable = true;

  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;

    # Low-latency audio configuration
    extraConfig.pipewire = {
      "10-rt-prio" = {
        "context.modules" = [
          {
            name = "libpipewire-module-rt";
            args = {
              "nice.level" = -11;
              "rt.prio" = 88;
            };
            flags = [ "ifexists" "nofail" ];
          }
        ];
      };
    };
  };

  # --- Networking & Localization ---
  networking = {
    hostName = "nixos";
    networkmanager = {
      enable = true;
      wifi.powersave = false;  # Disable WiFi power saving
    };
    # Faster DNS
    nameservers = [ "1.1.1.1" "8.8.8.8" ];
  };

  time.timeZone = "America/New_York";
  i18n.defaultLocale = "en_US.UTF-8";

  # --- User & Software ---
  users.users.radean = {
    isNormalUser = true;
    extraGroups = [ "networkmanager" "wheel" "video" "input" "realtime" ];
  };

  # Realtime scheduling for gaming/sim racing
  security.pam.loginLimits = [
    { domain = "@realtime"; type = "-"; item = "rtprio"; value = 99; }
    { domain = "@realtime"; type = "-"; item = "memlock"; value = "unlimited"; }
    { domain = "@realtime"; type = "-"; item = "nice"; value = -20; }
  ];

  users.groups.realtime = {};

  nixpkgs.config.allowUnfree = true;

  environment.systemPackages = with pkgs; [
    # Web Browsers
    google-chrome

    # Gaming & Windows Compatibility
    lutris
    bottles
    protonup-qt
    mangohud
    goverlay  # MangoHud configuration GUI
    vulkan-tools
    gamemode  # Auto-optimize games

    # Moza Management
    boxflat

    # System & Monitoring
    nvtopPackages.full
    btop
    intel-gpu-tools
    sbctl

    # Performance tools
    linuxPackages.cpupower  # CPU frequency control
    msr-tools
  ];

  programs.steam = {
    enable = true;
    protontricks.enable = true;
    gamescopeSession.enable = true;  # Enable gamescope for better performance
    extraCompatPackages = with pkgs; [
      proton-ge-bin
    ];
  };

  # GameMode for automatic performance optimization
  programs.gamemode = {
    enable = true;
    settings = {
      general = {
        renice = 10;
      };
      gpu = {
        apply_gpu_optimisations = "accept-responsibility";
        gpu_device = 0;
        amd_performance_level = "high";
      };
    };
  };

  # --- Storage Optimizations ---
  fileSystems."/run/media/radean" = {
    device = "/dev/disk/by-uuid/de66f12c-d787-485d-a207-3590e64045ae";
    fsType = "btrfs";
    options = [
      "defaults"
      "compress=zstd:1"  # Level 1 is faster than default
      "noatime"  # Significant performance improvement
      "nodiratime"
      "space_cache=v2"
      "ssd"  # Enable SSD optimizations
      "discard=async"
      "nofail"
    ];
  };

  # Optimize root filesystem if it's btrfs
  fileSystems."/" = {
    options = [ "noatime" "nodiratime" "compress=zstd:1" "space_cache=v2" ];
  };

  system.stateVersion = "26.05";
}
